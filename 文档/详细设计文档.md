# ID设置自动测试工装系统 - 详细设计文档

## 1. 系统架构设计

### 1.1 整体架构
采用分层架构设计，分为四个主要层次：
- **通信接口层**: 处理TCP/IP和RS232协议通信
- **数据处理层**: 负责数据解析、验证和转换
- **业务逻辑层**: 实现核心业务流程和控制逻辑
- **数据存储层**: 管理数据持久化和查询

### 1.2 技术架构
- **后端框架**: Spring Boot 2.7.0
- **前端界面**: JavaFX 17.0.2
- **数据库**: SQLite嵌入式数据库
- **通信协议**: Netty TCP/IP + jSSC串口通信
- **并发处理**: Java Thread Pool

## 2. 模块详细设计

### 2.1 条码扫描模块 (BarcodeScannerService)

#### 2.1.1 类设计
```java
public class BarcodeScannerService {
    private SerialPort serialPort;
    private Map<String, String> deviceBarcodeMap; // 设备号-条码映射
    private BlockingQueue<BarcodeData> barcodeQueue;
    
    public void initSerialPort(String portName, int baudRate) {}
    public BarcodeData readBarcode() throws SerialPortException {}
    public void bindDeviceBarcode(String deviceId, String barcode) {}
    public List<BarcodeData> getCachedBarcodes() {}
}
```

#### 2.1.2 数据结构
```java
public class BarcodeData {
    private String deviceId;    // 设备编号
    private String barcode;    // 条码内容
    private LocalDateTime scanTime; // 扫描时间
    private String portName;    // 串口名称
}
```

### 2.2 数据缓存模块 (DataCacheService)

#### 2.2.1 类设计
```java
public class DataCacheService {
    private ConcurrentHashMap<String, BarcodeData> barcodeCache;
    private LinkedBlockingQueue<BarcodeData> recentBarcodes;
    
    public void cacheBarcode(BarcodeData data) {}
    public int getBarcodeCount() {}
    public List<BarcodeData> getBarcodesByDevice(String deviceId) {}
    public void clearExpiredData(long timeoutMs) {}
}
```

#### 2.2.2 缓存策略
- 使用ConcurrentHashMap存储设备条码映射
- LRU算法管理最近使用的条码数据
- 定时清理过期数据（默认30分钟）

### 2.3 PLC通信模块 (PLCCommunicationService)

#### 2.3.1 类设计
```java
public class PLCCommunicationService {
    private Channel channel;
    private EventLoopGroup workerGroup;
    
    public void connectToPLC(String host, int port) {}
    public void sendValidationResult(boolean isValid) {}
    public ProductCountData receiveProductCount() {}
    public void waitForStartCommand() {}
}
```

#### 2.3.2 数据格式
```java
public class ProductCountData {
    private int productCount;     // 产品数量
    private LocalDateTime receiveTime; // 接收时间
    private String batchId;        // 批次ID
}
```

### 2.4 数据验证模块 (DataValidationService)

#### 2.4.1 类设计
```java
public class DataValidationService {
    public ValidationResult validateData(int productCount, int barcodeCount) {}
    public boolean isCountMatch(int expected, int actual) {}
    public void sendValidationResponse(boolean isValid) {}
}
```

#### 2.4.2 验证逻辑
```java
public class ValidationResult {
    private boolean isValid;      // 验证结果
    private String message;        // 结果消息
    private int expectedCount;     // 期望数量
    private int actualCount;      // 实际数量
}
```

### 2.5 烧录控制模块 (ProgramControlService)

#### 2.5.1 类设计
```java
public class ProgramControlService {
    private Channel programChannel;
    
    public void connectToProgramDevice(String host, int port) {}
    public void sendProgramCommand(List<BarcodeData> barcodes) {}
    public ProgramResult receiveProgramResult() {}
    public void handleProgramTimeout() {}
}
```

#### 2.5.2 指令格式
```java
public class ProgramCommand {
    private String command = "program";
    private List<BarcodeInfo> barcodes;
    private String batchId;
    private LocalDateTime sendTime;
}

public class BarcodeInfo {
    private String deviceId;
    private String barcode;
}
```

### 2.6 结果处理模块 (ResultProcessingService)

#### 2.6.1 类设计
```java
public class ResultProcessingService {
    private ProgramResultRepository resultRepository;
    
    public void saveProgramResult(ProgramResult result) {}
    public ProgramResult processRawResult(String rawData) {}
    public void sendToEMS(ProgramResult result) {}
    public List<ProgramResult> getBatchResults(String batchId) {}
}
```

#### 2.6.2 结果数据结构
```java
public class ProgramResult {
    private String status;         // 状态: success/failure
    private List<DeviceResult> results;
    private String batchId;
    private LocalDateTime completeTime;
}

public class DeviceResult {
    private String deviceId;
    private String barcode;
    private boolean result;       // 烧录结果
    private String errorMessage;  // 错误信息
}
```

### 2.7 EMS通信模块 (EMSCommunicationService)

#### 2.7.1 类设计
```java
public class EMSCommunicationService {
    private Channel emsChannel;
    
    public void connectToEMS(String host, int port) {}
    public void sendFinalResult(ProgramResult result) {}
    public void handleEMSResponse(String response) {}
    public void reconnectIfNeeded() {}
}
```

## 3. 数据库设计

### 3.1 表结构设计

#### 3.1.1 条码数据表 (barcode_data)
```sql
CREATE TABLE barcode_data (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    device_id VARCHAR(20) NOT NULL,
    barcode VARCHAR(50) NOT NULL,
    scan_time DATETIME NOT NULL,
    port_name VARCHAR(20),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.1.2 烧录结果表 (program_result)
```sql
CREATE TABLE program_result (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    batch_id VARCHAR(50) NOT NULL,
    device_id VARCHAR(20) NOT NULL,
    barcode VARCHAR(50) NOT NULL,
    result BOOLEAN NOT NULL,
    error_message TEXT,
    program_time DATETIME NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.1.3 系统日志表 (system_log)
```sql
CREATE TABLE system_log (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    level VARCHAR(10) NOT NULL,
    message TEXT NOT NULL,
    module VARCHAR(50) NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 3.2 索引设计
```sql
CREATE INDEX idx_barcode_device ON barcode_data(device_id);
CREATE INDEX idx_barcode_scan_time ON barcode_data(scan_time);
CREATE INDEX idx_program_batch ON program_result(batch_id);
CREATE INDEX idx_program_device ON program_result(device_id);
CREATE INDEX idx_log_module ON system_log(module);
CREATE INDEX idx_log_time ON system_log(created_at);
```

## 4. 通信协议设计

### 4.1 PLC通信协议
**请求格式**:
```json
{
  "type": "product_count",
  "data": {
    "count": 6,
    "timestamp": "2025-09-10T12:00:00"
  }
}
```

**响应格式**:
```json
{
  "type": "validation_result",
  "data": {
    "is_valid": true,
    "message": "OK",
    "expected": 6,
    "actual": 6
  }
}
```

### 4.2 烧录设备协议
**烧录指令**:
```json
{
  "command": "program",
  "batch_id": "BATCH_001",
  "barcodes": [
    {"device_id": "01", "barcode": "4C5A0000DE45"},
    {"device_id": "02", "barcode": "4C5A0000DE46"}
  ],
  "timestamp": "2025-09-10T12:00:00"
}
```

**烧录结果**:
```json
{
  "status": "completed",
  "batch_id": "BATCH_001",
  "results": [
    {
      "device_id": "01",
      "barcode": "4C5A0000DE45",
      "success": true,
      "message": ""
    },
    {
      "device_id": "02", 
      "barcode": "4C5A0000DE46",
      "success": false,
      "message": "编程失败"
    }
  ],
  "timestamp": "2025-09-10T12:05:00"
}
```

### 4.3 EMS系统协议
**结果推送**:
```json
{
  "type": "program_result",
  "batch_id": "BATCH_001",
  "results": [
    {
      "device_id": "01",
      "barcode": "4C5A0000DE45",
      "status": "success",
      "test_time": "2025-09-10T12:05:00"
    }
  ],
  "summary": {
    "total": 2,
    "success": 1,
    "failure": 1,
    "success_rate": 50.0
  }
}
```

## 5. 并发处理设计

### 5.1 线程池配置
```yaml
thread-pool:
  core-size: 12
  max-size: 24
  queue-capacity: 100
  keep-alive-time: 60
```

### 5.2 任务调度
- **条码扫描任务**: 串口监听线程
- **PLC通信任务**: Netty I/O线程组
- **数据处理任务**: 业务线程池
- **烧录控制任务**: 专用处理线程

### 5.3 同步机制
- 使用ConcurrentHashMap保证线程安全
- 使用BlockingQueue实现生产者-消费者模式
- 使用CountDownLatch进行批次同步
- 使用Atomic变量进行状态管理

## 6. 异常处理设计

### 6.1 异常分类
- **通信异常**: 网络中断、串口故障
- **数据异常**: 格式错误、校验失败
- **业务异常**: 验证不通过、烧录失败
- **系统异常**: 资源不足、内存溢出

### 6.2 处理策略
- 自动重试机制（最多3次）
- 异常日志记录
- 用户通知和告警
- 系统状态恢复

## 7. 性能优化设计

### 7.1 内存优化
- 使用对象池避免频繁创建
- 合理设置缓存大小
- 及时释放无用资源
- 使用高效的数据结构

### 7.2 IO优化
- 使用NIO非阻塞IO
- 批量处理减少IO次数
- 缓存磁盘读写操作
- 压缩传输数据

### 7.3 数据库优化
- 使用连接池管理数据库连接
- 批量插入和更新操作
- 合理的索引设计
- 定期清理历史数据

## 8. 部署设计

### 8.1 单机部署
```yaml
# application.yml
server:
  port: 8080

serial:
  ports: COM1,COM2,COM3,COM4,COM5,COM6
  baud-rate: 115200

plc:
  host: 192.168.1.100
  port: 9090

program-device:
  host: 192.168.1.101
  port: 9091

ems:
  host: 192.168.1.200
  port: 8080
```

### 8.2 监控配置
- Spring Boot Actuator健康检查
- 自定义性能指标监控
- 日志文件轮转策略
- 异常告警通知

---

*文档版本: V1.0*
*更新日期: 2025-09-10*