# ID设置自动测试工装系统 - 系统架构设计

## 1. 整体流程概述

采用分层架构设计，实现模块ID设置的自动化测试流程，支持6-12个模块并行处理。整体流程如下：

1. **条码扫描阶段**: 通过串口读取扫描枪条码数据，绑定设备号+扫描内容（条码），并缓存数据
2. **PLC数据验证**: PLC设备通过TCP传输JSON数据（包含产品个数），与缓存条码个数比对，相等则OK，否则发送异常指令
3. **烧录指令下发**: 等待PLC传送开始指令，接收到后给上位机传送烧录指令和多条条码信息
4. **烧录执行**: 上位机烧录完成后将多条条码信息+烧录结果回传
5. **结果处理**: 将烧录结果保存并回传给EMS系统


## 2. 硬件架构

### 2.1 硬件组件
- **PC工作站**: 运行上位机软件
- **EMS系统**: 生产管理系统
- **PLC设备**: 工业控制器
- **扫描枪**: 6-12个USB串口扫码枪
- **烧录上位机**: 模块烧录设备
- **串口服务器**: 支持一拖多串口扩展

### 2.2 硬件连接拓扑
```
扫描枪(6-12个) → 串口服务器 → PC工作站 (条码数据)
PLC设备 ↔ PC工作站 (TCP/IP，产品个数和指令)
烧录上位机 ↔ PC工作站 (TCP/IP，烧录指令和结果)
EMS系统 ↔ PC工作站 (TCP/IP，最终结果反馈)
```

## 3. 软件架构

### 3.1 架构分层
- **通信接口层**: TCP/IP + RS232协议通信
- **数据处理层**: 模块编码管理、测试流程控制
- **业务逻辑层**: 多线程并发处理、状态管理
- **数据存储层**: 测试日志和系统状态记录

### 3.2 技术栈
- **后端框架**: Spring Boot 2.7.0
- **前端界面**: JavaFX 17.0.2
- **数据库**: SQLite嵌入式数据库
- **通信协议**: Netty TCP/IP + jSSC串口通信
- **并发处理**: Java Thread Pool

## 4. 通信架构

### 4.1 PLC设备 ↔ 上位机软件 (TCP/IP)
- **产品个数传输**: JSON格式的产品数量数据
- **开始指令下发**: 启动烧录流程指令
- **异常指令反馈**: 条码数量不匹配时的异常通知

### 4.2 上位机软件 ↔ 烧录设备 (TCP/IP)
- **烧录指令传输**: 包含多条条码信息的烧录指令
- **烧录结果接收**: 烧录完成后的结果反馈

### 4.3 扫描枪 ↔ 上位机软件 (RS232)
- **条码数据读取**: 实时读取扫描枪的条码数据
- **设备号绑定**: 绑定设备号和对应的条码内容

### 4.4 EMS系统 ↔ 上位机软件 (TCP/IP)
- **最终结果反馈**: 将烧录结果保存并回传给EMS系统

## 5. 数据流架构

### 5.1 正向数据流
1. 扫描枪 → 上位机软件（条码数据，绑定设备号+条码内容）
2. PLC设备 → 上位机软件（JSON格式产品个数数据）
3. 上位机软件 → PLC设备（条码数量验证结果：OK/异常指令）
4. PLC设备 → 上位机软件（开始指令）
5. 上位机软件 → 烧录设备（烧录指令+多条条码信息）
6. 烧录设备 → 上位机软件（烧录结果+条码信息）
7. 上位机软件 → EMS系统（最终烧录结果）

### 5.2 数据格式规范
**PLC产品个数数据格式**:
```json
{"product_count": 6}
```

**烧录指令格式**:
```json
{
  "command": "program",
  "barcodes": [
    {"device_id": "01", "barcode": "4C5A0000DE45"},
    {"device_id": "02", "barcode": "4C5A0000DE46"}
  ]
}
```

**烧录结果格式**:
```json
{
  "status": "success",
  "results": [
    {"device_id": "01", "barcode": "4C5A0000DE45", "result": true},
    {"device_id": "02", "barcode": "4C5A0000DE46", "result": false}
  ]
}
```

## 6. 功能模块架构

### 6.1 核心功能模块
1. **条码扫描模块**: 通过串口读取扫描枪数据，绑定设备号+条码内容
2. **数据缓存模块**: 缓存扫描的条码数据，支持快速查询和比对
3. **PLC通信模块**: 与PLC设备进行TCP通信，接收产品个数和指令
4. **数据验证模块**: 比对PLC产品个数与缓存条码数量，发送验证结果
5. **烧录控制模块**: 管理烧录指令下发和结果接收
6. **结果处理极块**: 处理烧录结果并保存到数据库
7. **EMS通信模块**: 将最终结果反馈给EMS系统
8. **数据库存储**: 烧录日志和系统状态记录

### 6.2 并发处理架构
- **线程池配置**: 核心线程数6-12，最大线程数24
- **任务队列**: 阻塞队列容量100
- **线程工厂**: 自定义线程命名和优先级
- **拒绝策略**: 自定义任务拒绝处理机制

## 7. 系统特性

### 7.1 高性能特性
- **多线程并发**: 支持6-12个模块同时测试
- **高效通信**: 自定义二进制协议，减少传输开销
- **实时处理**: 毫秒级响应时间

### 7.2 可靠性特性
- **异常处理**: 完善的异常捕获和重试机制
- **连接管理**: 自动重连和心跳检测
- **数据校验**: 传输数据完整性验证

### 7.3 可维护性特性
- **模块化设计**: 各功能模块独立，便于维护
- **配置化管理**: YAML配置文件，灵活调整参数
- **日志记录**: 完整的操作日志和错误日志

## 8. 部署架构

### 8.1 单机部署
- **运行环境**: Java 8+ 运行环境
- **数据库**: SQLite嵌入式数据库
- **网络配置**: TCP端口8080，串口COM1-COM12

### 8.2 生产环境部署
- **数据库**: SQLite嵌入式数据库
- **高可用**: 支持多实例部署
- **监控**: 集成Spring Boot Actuator

## 9. 技术规格

### 9.1 性能指标
- **处理能力**: 6-12个模块/批次
- **响应时间**: <100ms
- **吞吐量**: 支持高并发处理

### 9.2 兼容性
- **操作系统**: Windows/Linux
- **Java版本**: JDK 8+
- **数据库**: SQLite嵌入式数据库

---

*文档版本: V1.1*
*更新日期: 2025-09-10*